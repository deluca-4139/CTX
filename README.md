## CTX ~ Concert Ticket Management
---

Welcome to **CTX**, a mock event and ticket management API written in ASP.NET and Postgres. It includes database schema for events and tickets and presents API endpoints that provide basic features such as 
* event creation/updating
* event information retrieval
* ticket reservation with variable time allowance
* ticket purchasing with plug-and-play payment options
* easy cancellation of tickets and deletion of events 
* and more!

Read on to learn more about it.

---

### Requirements and Setup

CTX expects that you have a functional Postgres server running and accessible. When cloning the repo, set up the local secrets and add the necessary keys with

```
$ dotnet user-secrets init
$ dotnet user-secrets set "DbUser" {postgres_username_here}
$ dotnet user-secrets set "DbPassword" {postgres_password_here}
```

You can run the provided `init_db.sh` script to set up the `tix` Postgres database locally, or you can do so manually with the schema provided in the next section. **Be warned that running the aforementioned script will delete any pre-existing database with the name "tix".** It will also populate the newly minted DB with some sample values for testing purposes.

---

### Schema

There are two tables in the local Postgres database with the following structures:
```
events
|- id (int) (unique, primary key)
|     generated sequentially by postgres as events are added to table
|- name (text)
|     name of the event
|- start (timestamp)
|     a timestamp (datetime in C#) corresponding to start time of the event
|- venue (text)
|     where the event is located
|- description (text)
|     self explanatory :p
|- capacity (int)
|     how many tickets the event can sell
|- sold (int)
|     how many tickets the event has sold

tickets
|- id (uuid) (unique, primary key)
|     generated by the server on ticket creation
|- event (int) (foreign key; references events(id))
|     the event ID that this ticket is for 
|- ticketholder (text)
|     name of person ticket is for
|- seating (text)
|     seating info 
|- reserved (boolean)
|     if this is true, then the ticket has been reserved for purchase, 
|     and expiry should be set
|- expiry (timestamp)
|     if this is set, then the ticket is in the process of being purchased. 
|     if it is null, the ticket has been purchased and reserved should be false
```

### Endpoints

While running, the .NET server exposes the following endpoints:

* `GET /events`
  * retrieves a list of all events in the database (read: in the `events` table) and their information
  * returns `200 OK`
* `GET /events/{id}`
  * retrieves a single event's information
  * returns:
    * `200 OK` with event information, if event exists
    * `404 Not Found` if it does not
* `POST /events`
  * creates a new event, adding it to the database('s `events` table)
  * expects that the provided JSON is of the shape `Event`
  * returns:
    * `201 Created` along with a link to the resource if creation was successful
* `PUT /events/{id}`
  * updates the information for an existing event
  * expects that the provided JSON is of the shape `Event`
  * returns:
    * `200 OK` if the updating was successful
    * `404 Not Found` if provided event ID doesn't exist
* `POST /events/{id}/reserve`
  * reserves a ticket for the specified event
  * expects that provided JSON will be a partial `Ticket` shape; i.e. have strings defining the `ticketholder` and `seating` properties
  * returns:
    * `201 Created` along with the UUID of the newly created ticket if the ticket was succesfully reserved
    * `404 Not Found` if the event does not exist
    * `409 Conflict` if there was in issue with reservation, along with a string detailing the issue
* `POST /tickets/{id}/purchase`
  * purchases a reserved ticket, confirming the reservation
  * returns:
    * `200 OK` if purchase succeeds
    * `402 Payment Required` if payment fails
    * `404 Not Found` if ticket does not exist
    * `409 Conflict` if ticket exists but has already been purchased
    * `410 Gone` if ticket reservation has expired 
  * N.B.: in the event of a `410 Gone` response, the reservation will be deleted from the database; further POST requests to the same endpoint will result in `404 Not Found`
* `DELETE /events/{id}`
  * deletes specified event from the database
  * returns:
    * `200 OK` on success
    * `404 Not Found` if event does not exist
* `DELETE /tickets/{id}`
  * deletes specified ticket from the database
  * returns:
    * `200 OK` on success
    * `404 Not Found` if ticket does not exist